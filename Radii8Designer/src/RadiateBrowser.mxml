<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009"
			   xmlns:s="library://ns.adobe.com/flex/spark"
			   xmlns:mx="library://ns.adobe.com/flex/mx"
			   xmlns:views="com.flexcapacitor.views.*"
			   xmlns:utils="com.flexcapacitor.utils.*"
			   xmlns:ebutils="com.earthbrowser.ebutils.*" 
			   xmlns:local="*"
			   
			   width="100%" height="100%" 
			   minWidth="800" minHeight="400"
			   applicationComplete="applicationCompleteHandler(event)" 
			   initialize="application1_initializeHandler(event)"
			   frameRate="50"
			   pageTitle="Radiate" 
			   >

	
	<fx:Script>
		<![CDATA[
			import com.earthbrowser.ebutils.MacMouseWheelHandler;
			import com.flexcapacitor.controller.Radiate;
			import com.flexcapacitor.controls.AceEditor;
			import com.flexcapacitor.events.HTMLDragEvent;
			import com.flexcapacitor.managers.DragManagerImpl;
			import com.flexcapacitor.model.HTMLDragData;
			import com.flexcapacitor.model.IDocument;
			import com.flexcapacitor.skins.CallOutSkin;
			import com.flexcapacitor.utils.ClassRegistry;
			import com.flexcapacitor.utils.DocumentTranscoder;
			import com.flexcapacitor.utils.HTMLDragManager;
			import com.flexcapacitor.utils.PopUpOverlayManager;
			import com.google.code.flexiframe.IFrame;
			
			import mx.events.FlexEvent;
			
			include "build.as";
			
			[Embed(source="Radii8Desktop-app.xml", mimeType="application/octet-stream")]
			public var appInfo:Class;
			public var applicationDescriptor:XML;
			private var calloutSkin:CallOutSkin;
			private var dragManager:DragManagerImpl;
			
			/**
			 * @private
			 * */
			[Bindable]
			public var radiate:Radiate;
			
			/**
			 * Setup the environment. If remote set WP host and path. 
			 * If running on the desktop or not using remote service
			 * we will need to change the message
			 * */
			protected function applicationCompleteHandler(event:FlexEvent):void {
				var path:String;
				var appNamespace:Namespace;
				var versionNumber:String;
				var quality:String;
				
				quality = StageQuality.BEST;
				stage.quality = quality;
				
				radiate = Radiate.getInstance();
				
				radiate.buildNumber = BUILD_NUMBER;
				radiate.buildDate = BUILD_DATE;
				radiate.buildTime = BUILD_TIME;
				
				applicationDescriptor = new XML(new appInfo());
				appNamespace = applicationDescriptor.namespace();
				versionNumber = applicationDescriptor.appNamespace::versionNumber;
				radiate.versionNumber = versionNumber;
				
				startupBrowser();
				
				if (url.indexOf("http://localhost")==0) {
					path = "http://www.radii8.com"; // when running locally
				}
				
				Radiate.startup(this, mainView, path);
				
				listenForDragAndDrop();
				
				var classRegistry:ClassRegistry = ClassRegistry.getInstance();
				var transcoder:DocumentTranscoder = new DocumentTranscoder();
				var application:XML = transcoder.getDefaultMXMLDocumentXML();
				
				var walker:Walker = new Walker(startupBrowser);
				
				classRegistry.addNamespaces(application);
				//componentName = component.@id;
				//componentClass = component.attribute(CLASS);
				//Walker;
				//var className:String = "BlackAndWhiteFilter";
				//var componentClass:String = "com.flexcapacitor.filters.BlackAndWhiteFilter";
				//var componentQName:QName = new QName(MXMLDocumentConstants.fcNamespaceURI, className);
				//classRegistry.registerClass(componentQName, componentClass);
			}
			
			protected function application1_initializeHandler(event:FlexEvent):void {
				//var version:String = LoaderConfig.swfVersion;
				// get pixels of images for drag and drop in 
				JPEGLoaderContext;
				var sandboxType:String = Security.sandboxType;
				Security.allowDomain("*");
				Security.allowInsecureDomain("*");
				Security.disableAVM1Loading = true;
				var overlayTypes:Array = [IFrame, AceEditor];
				new PopUpOverlayManager(null, overlayTypes);
				MacMouseWheelHandler.init(systemManager.stage);
				//stage.quality = StageQuality.HIGH_16X16_LINEAR;
			}
			
			private function startupBrowser():void {
				radiate.applicationMenu = mainView.mainMenuBar;
			}
			
			public var htmlDragAndDrop:HTMLDragManager;
			
			private function listenForDragAndDrop():void {
				HTMLDragManager.debug = false;
			}
			
			public function dragHandler(event:HTMLDragEvent):void {
				var type:String = event.type;
				if (type==HTMLDragManager.DRAG_ENTER) {
					mainView.dropImagesLocation.visible = true;
					PopUpOverlayManager.instance.hideAllOverlays();
				}
				else if (type==HTMLDragManager.DRAG_EXIT) {
					mainView.dropImagesLocation.visible = false;
				}
			}
			
			public function dragDropHandler(event:HTMLDragEvent):void {
				var selectedDocument:IDocument;
				
				if (HTMLDragData(event.data).mimeType==HTMLDragManager.INVALID) {
					Radiate.warn("The item you have dropped is invalid. Some supported types include png, jpg, jpeg and gif images");
					PopUpOverlayManager.instance.showAllOverlays();
					mainView.dropImagesLocation.visible = false;
					return;
				}
				
				selectedDocument = radiate.selectedDocument;
				PopUpOverlayManager.instance.showAllOverlays();
				mainView.dropImagesLocation.visible = false;
				
				Radiate.info("Opening... Hold on...");
				Radiate.callAfter(500, openDraggedItem, event, !event.shiftKey);
			}
			
			public function openDraggedItem(event:HTMLDragEvent, resizeIfNeeded:Boolean = true):void {
				var createDocument:Boolean;
				var createDocumentIfNeeded:Boolean = true;
				
				radiate.dropItemWeb(event, createDocument, createDocumentIfNeeded, resizeIfNeeded);
			}
			
		]]>
	</fx:Script>
	
	<!-- 
	NOTICE! There are notes that go with this project. They have been moved to readme.txt -->
	
	<!--
	preloader="RadiatePreloader"
	preloader="com.flexcapacitor.preloaders.RegisteringPreloader"
	preloader="mx.preloaders.SparkDownloadProgressBar"
	
	
	Description	Resource	Path	Location	Type
	unable to open '/Applications/Adobe Flash Builder 4.7/sdks/4.15 AIR 23/frameworks/libs/player/15.0/playerglobal.swc'	Radii8		Unknown	Flex Problem
	
	fix: 
	removed references in compiler build path to old libraries and applied the properties. 
	
	sometimes parent is null in DragProxy
	line 648:
	m.xTo = parent.mouseX;
	m.yTo = parent.mouseY;
	
	maybe monkey patch with a null check
	-->
	
	<!--
	show all properties if inspector is not available 
	add option to hide code in html view 
	upload image automatically 
	add delete attachment 
	add automatically save document 
	remove inspector panel 
	remove focus rect in properties panel items 
	add items from documents to assets array 
	attach uploads to project document 
	add uploaded icon to assets
	
	ArgumentError: Error #2004: One of the parameters is invalid.
	at flash.display::Graphics/drawRect()
	at spark.components.supportClasses::TextBase/updateDisplayList()[/Users/aharui/release4.13.0/frameworks/projects/spark/src/spark/components/supportClasses/TextBase.as:734]
	at mx.core::UIComponent/validateDisplayList()[/Users/aharui/release4.13.0/frameworks/projects/framework/src/mx/core/UIComponent.as:9531]
	
	
	When testing locally I'm getting this error: 
	
	
	Warning: Domain www.radii8.com does not specify a meta-policy.  
	Applying default meta-policy 'master-only'.  This configuration is deprecated.  
	See http://www.adobe.com/go/strict_policy_files to fix this problem.
	
	Error: Request for resource at https://www.radii8.com/r8m/?json=user/get_logged_in_user 
	by requestor from http://localhost:8888/Radii8-debug/RadiateBrowser.swf is denied due 
	to lack of policy file permissions.
	
	*** Security Sandbox Violation ***
	Connection to https://www.radii8.com/r8m/?json=user/get_logged_in_user halted - not permitted from http://localhost:8888/Radii8-debug/RadiateBrowser.swf
	Error: Request for resource at https://www.radii8.com/r8m/?json=core/get_category_posts&count=100&slug=Tutorial by requestor from http://localhost:8888/Radii8-debug/RadiateBrowser.swf is denied due to lack of policy file permissions.

	
	Changed to https and now got this error in the browser: 
	
	Secure Connection Failed
	
	An error occurred during a connection to localhost:8888. SSL received a record that exceeded the maximum permissible length. Error code: SSL_ERROR_RX_RECORD_TOO_LONG
	
	The page you are trying to view cannot be shown because the authenticity of the received data could not be verified.
	Please contact the website owners to inform them of this problem.
=-->
	
	<fx:Style source="fonts.css" />
	<fx:Style source="styles.css" />
	
	<fx:Declarations>
		<ebutils:MacMouseWheelHandler />
		<utils:SecureRedirect />
		<utils:HTMLKeyboardHandler />
		<utils:HTMLDragManager dragDrop="dragDropHandler(event)"
							   dragEnter="dragHandler(event)"
							   dragExit="dragHandler(event)"/>

		<utils:MiniInspector showDisplayObjectOutlines="true"
							 showRuler="false"
							 runOnMouseDown="true"
							 showStyleInheritanceInformation="false"
							 showAllStyleDeclarations="false"
							 showColorUnderMouse="false"
							 enabled="true"
							 showHTMLErrors="false"
							 />
	</fx:Declarations>

	<views:MainView id="mainView" width="100%" height="100%" />
	
</s:Application>
